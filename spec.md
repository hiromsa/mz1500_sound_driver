# MZ-1500 サウンドドライバ仕様書 (Draft)

## 1. 概要
SHARP MZ-1500 のサウンド機能コンポーネントを最大限に引き出すための音楽制作環境（MMLコンパイラ＋再生環境＋ドライバ）を構築する。
Windows環境にてC# .NET 9.0を用いて作成し、Windows上での直接再生(手軽なプレビュー体験)と、MZ-1500実機・エミュレータ向けファイル（qdcフォーマット）出力の両立を目指す。

## 2. ターゲットハードウェア仕様 
MZ-1500のサウンド仕様は以下の通り：
* **DCSG 1 (SN76489互換)**: 矩形波 x 3, ノイズ x 1
* **DCSG 2 (SN76489互換)**: 矩形波 x 3, ノイズ x 1
* **BEEP (Intel 8253)**: 単音(矩形波)
* **最大同時発音数**: 矩形波7ch + ノイズ2ch

## 3. ソフトウェア構成
本システムは以下の主要コンポーネントから構成される：
1. **MMLコンパイラ (Windows / C# .NET 9.0)**
   * 「強力なMML」テキストフォーマットをパースし、各チャンネル向けのシーケンスデータへ変換する。
2. **プレビュープレイヤ (Windows / C# .NET 9.0)**
   * コンパイルされたデータをWindows上で即座に再生する。
   * 波形合成によりDCSGおよびBEEPの挙動をエミュレートする。
3. **qdcエクスポータ (Windows / C# .NET 9.0)**
   * MZ-1500エミュレータ/実機で読み込み可能なqdc (Quick Disk) イメージ等へ書き出す。
4. **サウンドドライバ (MZ-1500 / Z80 Assembly)**
   * MZ-1500上で動作し、生成されたデータを読み込みながらDCSG/BEEPを制御・発音する再生用ドライバプログラム。

## 4. MML仕様方針 (強力なMML入力)
将来的にGUI入力（トラッカーやピアノロール）にも対応できるよう、中間オブジェクト(AST)への変換を前提とした汎用的な設計を行う。
当面のテキストMMLでの表現力として以下を想定する：
* **音階・音符**: `c d e f g a b`, `+ -` (シャープ/フラット), `,` (付点), 音符長指定 など標準記法
* **トラック/チャンネルルーティング**: DCSG1, DCSG2, BEEP への任意割り当て
* **高度な表現**: ソフトウェアエンベロープ(音量, ピッチ), LFOレイヤー (ビブラート, ポルタメント, アルペジオ, ピッチスイープ)
* **制御構文**: 多重ループ `[ ]` 構文や、反復記号、マクロ展開機能

### 4.1 基本MMLコマンド仕様
| コマンド | 内容 | 解析および処理イメージ |
| :--- | :--- | :--- |
| `[A-Za-z]` ヘッダ | トラック定義 | `A o4v15` のように行頭等で指定された文字で書き込み先トラックを切り替える。複数記述可。 |
| `t`, `@t` | テンポ指定 | `t150` または `@t1,86` のような記法。四分音符長からTickやサンプル長へ変換。 |
| `o` | オクターブ | `o4` なら中央のド付近。 |
| `<>` | オクターブ増減 | `currentOctave++` または `--`。 |
| `l` | デフォルト音長| `l4` なら四分音符。 |
| `v`, `@v`, `@`| 音量/エンベロープ指定| `v15` 等の音量指定、およびソフトウェアエンベロープ番号指定。MZ-1500のハードウェア上、デューティ比の変更は不可のためサポートしない。 |
| `a-g` (+-#) | 音名 | 音名とオクターブから周波数を決定。直後の数値で音長指定、`.` で付点。 |
| `r` | 休符 | 周波数を0（無音）として指定時間待機。 |
| `q`, `@q` | ゲート制限 | 発音時間の何％(`q`) / 何フレーム(`@q`) を鳴らすかの計算 (クオンタイズ)。 |
| `[` `]` | リピート | `[ c d e ]2` のように囲んだ範囲を指定回数繰り返す。入れ子対応。 |
| `L` | ループポイント| 曲の終わりに到達した際、このマーカー位置へ戻って永続ループする。 |

## 5. 技術スタック
* 開発言語: C# .NET 9.0 (ツールチェイン本体)
* Z80クロスアセンブラ: z80asm や rasm 等（検討中）

## 6. 将来の拡張
* CLIベースでのコンパイル・プレビュー再生からのスタートとし、コアをライブラリ化（DLL化）しておくことで、その上位レイヤーにGUIフロントエンド(WPF, WinForms, Avalonia等)を被せられるアーキテクチャ設計とする。
