# MZ-1500 サウンドドライバ仕様書 (Draft)

## 1. 概要
SHARP MZ-1500 のサウンド機能コンポーネントを最大限に引き出すための音楽制作環境（MMLコンパイラ＋再生環境＋ドライバ）を構築する。
Windows環境にてC# .NET 9.0を用いて作成し、Windows上での直接再生(手軽なプレビュー体験)と、MZ-1500実機・エミュレータ向けファイル（qdcフォーマット）出力の両立を目指す。

## 2. ターゲットハードウェア仕様 
MZ-1500のサウンド仕様は以下の通り：
* **DCSG 1 (SN76489互換)**: 矩形波 x 3, ノイズ x 1
* **DCSG 2 (SN76489互換)**: 矩形波 x 3, ノイズ x 1
* **BEEP (Intel 8253)**: 単音(矩形波)
* **最大同時発音数**: 矩形波7ch + ノイズ2ch

## 3. ソフトウェア構成
本システムは以下の主要コンポーネントから構成される：
1. **MMLコンパイラ (Windows / C# .NET 9.0)**
   * 「強力なMML」テキストフォーマットをパースし、各チャンネル向けのシーケンスデータへ変換する。
2. **プレビュープレイヤ (Windows / C# .NET 9.0)**
   * コンパイルされたデータをWindows上で即座に再生する。
   * 波形合成によりDCSGおよびBEEPの挙動をエミュレートする。
3. **qdcエクスポータ (Windows / C# .NET 9.0)**
   * MZ-1500エミュレータ/実機で読み込み可能なqdc (Quick Disk) イメージ等へ書き出す。
4. **サウンドドライバ (MZ-1500 / Z80 Assembly)**
   * MZ-1500上で動作し、生成されたデータを読み込みながらDCSG/BEEPを制御・発音する再生用ドライバプログラム。

## 4. MML仕様方針 (強力なMML入力)
将来的にGUI入力（トラッカーやピアノロール）にも対応できるよう、中間オブジェクト(AST)への変換を前提とした汎用的な設計を行う。
当面のテキストMMLでの表現力として以下を想定する：
* **音階・音符**: `c d e f g a b`, `+ -` (シャープ/フラット), `,` (付点), 音符長指定 など標準記法
* **トラック/チャンネルルーティング**: DCSG1, DCSG2, BEEP への任意割り当て
* **高度な表現**: ソフトウェアエンベロープ(音量, ピッチ), LFOレイヤー (ビブラート, ポルタメント, アルペジオ, ピッチスイープ)
* **制御構文**: 多重ループ `[ ]` 構文や、反復記号、マクロ展開機能

### 4.1 基本MMLコマンド仕様
| コマンド | 内容 | 解析および処理イメージ |
| :--- | :--- | :--- |
| `[A-Za-z]` ヘッダ | トラック定義 | `A o4v15` のように行頭等で指定された文字で書き込み先トラックを切り替える。複数記述可。 |
| `t`, `@t` | テンポ指定 | `t150` または `@t1,86` のような記法。四分音符長からTickやサンプル長へ変換。 |
| `o` | オクターブ | `o4` なら中央のド付近。 |
| `<>` | オクターブ増減 | `currentOctave++` または `--`。 |
| `l` | デフォルト音長| `l4` なら四分音符。 |
| `v`, `@v`| 音量/エンベロープ指定| `v15` 等の音量指定、およびソフトウェアエンベロープ番号指定。
| `a-g` (+-#) | 音名 | 音名とオクターブから周波数を決定。直後の数値で音長指定、`.` で付点。 |
| `r` | 休符 | 周波数を0（無音）として指定時間待機。 |
| `q`, `@q` | ゲート制限 | 発音時間の何％(`q`) / 何フレーム(`@q`) を鳴らすかの計算 (クオンタイズ)。 |
| `L` | ループポイント| 曲の終わりに到達した際、このマーカー位置へ戻って永続ループする。 |

### 4.2 ソフトウェア音量エンベロープ (`@v`) 仕様
MZ-1500のSN76489互換音源モジュールはハードウェアによる自動減衰エンベロープを持たないため、本システムではソフトウェア制御による疑似エンベロープ（音量変化）記法をサポートする。

#### エンベロープデータの定義
- トラック記述領域（曲の先頭など）にて、`@v[番号] = { ボリューム値1, 定数値2... }` の形式で定義する。
- **配列の要素数**: 任意の長さ。フレーム(60Hz=約16.6ms)単位での音量推移を示す。
- **ボリューム値**: `0` (無音) ～ `15` (最大音量) までの整数値。
- **終端マーカ**: 内部的には配列の末尾到達時（または`255(0xFF)`到達時）にループ終端とみなし、最後の音量値を維持し続ける。

**定義例:**
```mml
@v0 = {15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0}
@v1 = {15,15,15,15, 10,10,10,10, 5,5,5,5, 0}
```

#### エンベロープの適用・解除
- 対象のトラック内で `@v[定義番号]` を記述すると、それ以降の音符発音時に定義したエンベロープ波形が自動適用される。
- エンベロープ適用中は、通常の `v` コマンド(固定音量)による指定はオーバーライドされる。
- エンベロープを解除(OFF)して通常の固定音量に戻す場合は `@v` (番号なし) を記述する。

**適用例:**
```mml
A o4 l8 @v0 c d e @v1 f g @v a b >c
```

#### 内部実装（Z80ドライバおよびWindowsプレビュー）
- **C# プレビュー再生**: 波形生成オシレータ内で、`60Hz`相当のサンプル経過時間をインデックスとして配列を参照し、`0-15`の値を浮動小数点ボリュームに変換して乗算する。
- **Z80ドライバ (qdc)**: コンパイラが割り当てたエンベロープデータテーブル領域を参照。割り込み周期(1/60秒)ごとにデータを1バイト読み出してSN76489のボリュームレジスタ(`1001ccvv`)を叩き、フェードアウト/ポルタメント等の音量推移を表現する。各音符(Note On)の読み込み時にエンベロープポインタは先頭(`0x00`)へリセットされる。

## 5. 技術スタック
* 開発言語: C# .NET 9.0 (ツールチェイン本体)
* Z80クロスアセンブラ: z80asm や rasm 等（検討中）

## 6. 将来の拡張
* CLIベースでのコンパイル・プレビュー再生からのスタートとし、コアをライブラリ化（DLL化）しておくことで、その上位レイヤーにGUIフロントエンド(WPF, WinForms, Avalonia等)を被せられるアーキテクチャ設計とする。
