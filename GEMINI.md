# MZ-1500 Sound System: AI Assistant Guidelines

このファイルは、AIアシスタント（Gemini）との共同開発において遵守および参照すべきプロジェクト固有のルールや方針を定義するものです。
AIエージェントは、Z80アセンブリ言語やレトロPCのハードウェア制御、音源チップの仕様を考慮した上で、効率的かつ正確なコーディングをサポートしてください。

## 1. プロジェクト方針と前提
- 言語は原則として日本語でコミュニケーションする。
- ソースコードの記述は C# .NET 9.0 の仕様に準拠する。
- ターゲットハードウェア（MZ-1500内蔵・Z80）の制約を常に考慮し、メモリや処理速度に影響の大きい実装には慎重な判断を行う。

## 2. アセンブリ実装のルール
- `Z80Parts.cs` や `MZ1500MusicAssembler.cs` などのアセンブラ出力部では、過度な最適化による副作用（レジスタ破壊、タイミングズレ）を避けるため、安全性と動作の確実性を優先する。
- 最適化よりも、まずは動作する実装（LDIRなど確実な命令に頼る）を選ぶこと。

## 3. コードフォーマットと設計指針
- Windows用プレビューとZ80用バイナリのロジックが乖離しないよう、C#側で行うエミュレーションは極力Z80の制約に合わせるか、その差異をコメントで明文化する。
- ユーザーに直感的なUI（Avalonia UI等）を提供する際は、使いやすさとレスポンスを重視する。

## 4. ドキュメントの維持
- `readme.md` や `mml_reference.md` に記載された仕様の整合性を維持すること。新しい機能を追加した際は、必ず該当する仕様書・ガイドのアップデート作業を伴うこと。

## 5. コードの変更と自動保存のルール（確認スキップ設定）
- **自動編集の許可:** `src/` や `asm/` など、ソースコードが格納されているディレクトリ配下のファイルについては、ユーザーの事前確認なしで自律的にコードを修正・保存して構いません。
- **設定ファイルの保護:** ただし、ビルドスクリプト（Makefileなど）や環境設定ファイルを変更する場合は、必ず事前にユーザーへ変更内容を提案し、許可を得てください。

## 6. ビルドとテストの自動実行ルール（無限ループ防止）
- **自動ビルドの許可:** コードの修正後、ユーザーの確認を待たずに自律的にビルドコマンド（例: `make` や アセンブラのコンパイルコマンドなど）を実行して動作確認を行って構いません。
- **【重要】ストッパー機能:** ビルドエラーが発生した場合、自律的にコードを修正して再実行してもよいですが、**エラーが3回連続で解決しなかった場合は直ちに作業を停止**し、現状のエラーログと考察をユーザーに報告して指示を仰いでください。

## 7. Git運用のルール（自律コミットとPushの禁止）
- **こまめなコミット:** 機能の実装、バグ修正、または意味のある論理的な区切りごとに、自律的に `git add .` と `git commit` を実行してください。
- **コミットメッセージ:** 変更内容が後から見て分かりやすいように、Conventional Commitsの形式に従い日本語で簡潔に記述してください。（例: `feat: サウンド初期化ルーチンの追加`, `fix: レジスタ書き込み時のウェイト調整`）
- **【厳守】Pushの禁止:** **いかなる場合も、自律的に `git push` を実行してはいけません。** コミットが完了した段階で作業を止め、「コミットが完了しました。動作確認後に手動でPushしてください」とユーザーに報告してください。

## 8. 安全性と禁止事項
- `rm -rf` などの破壊的なコマンドや、システム全体に影響を及ぼすコマンドは絶対に実行しないでください。
- 不確かな仕様（特にハードウェアのI/Oポートやレジスタの挙動）について推測でコードを書かず、不明な点はユーザーに質問するか、公式リファレンス等の情報を求めてください。
