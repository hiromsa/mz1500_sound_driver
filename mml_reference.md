# MZ-1500 サウンドドライバ MML リファレンス

本ドキュメントは、MZ-1500向け拡張サウンドドライバで利用可能なMML（Music Macro Language）の仕様と、SN76489の機能を引き出すための活用ノウハウをまとめたものです。

## 1. トラック構成
本システムは、MZ-1500に搭載されている2基のSN76489互換音源モジュール（DCSG）および1基のIntel 8253（BEEP）を統合的に制御します。

| トラック記号 | 割当ハードウェア | 音色仕様 |
| :---: | :--- | :--- |
| **A, B, C** | DCSG 1 | 矩形波 x 3 |
| **D** | DCSG 1 | ノイズ波形 x 1 |
| **E, F, G** | DCSG 2 | 矩形波 x 3 |
| **H** | DCSG 2 | ノイズ波形 x 1 |
| **P** | Intel 8253 | 矩形波(BEEP) x 1 |

*MMLの行頭にトラック記号を記述することで、その行のデータをどのチャネルへ送るかを指定できます（例: `A o4cdef`）。複数指定も可能です（例: `ABC o5c`）。*

---

## 2. 記述ルール（コメント等）
MML内にメモや説明を残すための「コメント機能」が利用できます。

* `;`（セミコロン）または `/`（スラッシュ）を記述すると、**それ以降から行末までがすべてコメント**として扱われ、演奏時には無視されます。
* 行の先頭に書いて行全体をコメントアウトしたり、コードの右側にメモを追記するのに使えます。

**記述例:**
```mml
; ここは曲のタイトルなどのメモを書く行です
/ スラッシュでも同様にコメントになります

A o4 cdef ; ここから先はコメントとして無視されます
```

---

## 3. 基本コマンド一覧

| コマンド | 書式例 | 説明 |
| :--- | :--- | :--- |
| `c d e f g a b` | `c` | 音符（ドレミファソラシ）。`+` または `#` で半音上げ、`-` で半音下げ。直後に数値を記述で音符長を指定（省略時はデフォルト音長）。`.`で付点。 |
| `r` | `r` | 休符。休みの長さをあとに続けて指定することも可能。 |
| `o` | `o4` | オクターブ指定。標準は `o4`（中央のド周辺）。 |
| `<` `>` | `<` | オクターブの相対変更。`<` でオクターブを1下げ、`>` で1上げる。 |
| `l` | `l8` | デフォルトの音符長を指定。`l4`=4分音符、`l8`=8分音符。 |
| `t` | `t120` | 曲のテンポ指定（BPM：1分間あたりの四分音符の数）。 |
| `v` | `v15` | ボリューム指定。`0`(無音) ～ `15`(最大音量)。 |
| `q` | `q7` | クオンタイズ（ゲートタイム/発音時間）指定。`1`～`8`。8を指定するとスラー（隙間なし）になる。標準は `7`。 |
| `^` | `c4^8` | タイ。直前の音符の発音を後ろの音符分だけ延長して繋げる。 |
| `{ } n` | `{gag}2` | 連符。括弧内の複数の音符を指定した長さの中で均等に発音する。 |
| `K` | `K-2` | トランスポーズ（移調）。半音単位で後続のすべての音符のピッチをずらす（負の値も可）。`K0`でリセット。必ず大文字を使用する。 |
| `@t` | `@t1,86` | フレーム単位のテンポ指定。`@t<N分音符>,<何フレームか>`。 |
| `@q` | `@q1` | フレーム単位のゲートカット（クオンタイズ）。指定したフレーム数だけ発音を短く切る。 |
| `D` | `D10` | ディチューン指定。セント単位でトラック全体のピッチをずらす（負の値 `D-10` も可）。 |
| `@EP` | `EP1` | ピッチエンベロープ（後述）の適用。`EP255`で解除。 |
| `@v` | `@v1` | 音量エンベロープ（後述）の適用。`@v`のみ（引数なし）で解除。 |
| `[ ] n` | `[cde]2` | 繰り返しループ。括弧内のフレーズを `n` 回繰り返す。`n` 省略時は2回。入れ子（多重ループ）対応。 |
| `@wn` | `@wn0` | ノイズ波形指定。ノイズ専用トラック(D, H)向け。`@wn0`: 周期ノイズ, `@wn1`: ホワイトノイズ(標準)。 |
| `@in` | `@in1` | ノイズ連動指定。矩形波トラック(C, G)とノイズ(D, H)の同期駆動指定。`@in0`: オフ, `@in1`: 周期, `@in2`: ホワイト。 |
| `L` | `L` | ループポイントの指定。曲の終端到達時にこのマーカー位置へ戻る。 |

---

## 4. エンベロープマクロ仕様
MZ-1500のPSGは波形の自動減衰（ハードウェアエンベロープ機能）を持たないため、ソフトウェアによる疑似エンベロープを使用します。

### 4.1 音量エンベロープ (`@v`)
曲の先頭などで `@v[番号] = { 音量推移 }` の形式でマクロを定義し、トラック内で呼び出すことで適用します。
* **値域**: `0` (無音) ～ `15` (最大音量)
* **推移速度**: 毎フレーム (1/60秒) ごとに1要素進む
* **連続指定**: `値 x 回数`（例: `15x3`）で同じ値を省略記法できる
* **ループ**: `|` 記号を挟むと、末尾到達時にそこへ戻ってループする

**定義例:**
```mml
@v0 = {15, 12, 9, 6, 3, 0}         ; 減衰音（ピアノやギター風）
@v1 = {15, 14, 13, |, 11, 10}      ; 10まで下がったら11へ戻ってループ
@v2 = {15x4, 10x4, 5x4, 0}         ; 15,15,15,15, 10,10,10,10... と展開される
```

### 4.2 ピッチエンベロープ (`@EP` / `EP`)
音の高さを連続的に変化させます（ビブラートやピッチスイープ）。定義の記法は音量エンベロープと同じです。
* **値域**: **セント値**（100セント＝半音）。マイナス値も指定可能。

**定義例:**
```mml
@EP0 = {0, 10, 20, 30, 40}        ; 徐々にピッチが上がるスラー
@EP1 = {10, -10, |, 10, -10}      ; 素早いビブラート
@EP2 = {0x5, 10x5, 20x5, 30x5}    ; ポルタメント階段
```

---

## 5. ノイズチャネル (`D`, `H`) の高度な活用ノウハウ
Dトラック（およびHトラック）はノイズ専用チャネルです。SN76489のノイズジェネレータは非常にユニークで強力な仕様を持っています。

### 5.1 ノイズコマンド仕様

| コマンド | パラメータ | 説明 |
| :--- | :--- | :--- |
| `@wn` | `0` or `1` | ノイズ波形の指定。`@wn0`＝周期ノイズ(金属的)、`@wn1`＝ホワイトノイズ（標準。ザァーッという音） |
| `@in` | `0` or `1` or `2`| トーン3（チャネルCまたはG）連動モード（**同期ノイズ**）。`0`: オフ, `1`: トーン3周期ノイズ, `2`: トーン3ホワイトノイズ |

`@in` を指定しない通常モード（**固定ノイズ**）の場合、音の高さ(c, d, e...)は無視され、以下のように大まかな3段階の「シフトレート（低/中/高の荒さ）」のみ切り替わります。

* `c` ～ `d` 周辺: Lowレートノイズ（ザクッ、ゴワッという荒い音）
* `e` ～ `f` 周辺: Midレートノイズ（シャッ、という中間の音）
* `g` 以上: Highレートノイズ（サーッという細かい音）

### 5.2 トーン3連動モード（同期ノイズ）の極意
`@in1`（周期）また `@in2`（ホワイト）を宣言すると、ノイズトラックは**「隣り合うトーンチャネルの周波数(CまたはG)をクロックとして」**ノイズの乱数を発生させます。

この状態のノイズトラックは、**C/Gで鳴らした音程をそのまま「ノイズの肌理（きめ）の細かさ」として反映**します。つまり、超高音を鳴らせば細かいノイズに、低音を鳴らせば粗いノードル音を作り出すことができます。

#### 💡 ノウハウ①: きめの細かいホワイトノイズの作成
通常のハイハットやシンバルのような「サーッ」というノイズを作りたい場合、通常の固定ノイズ（High）よりもさらに細かい音を出すため、以下のように**極端に高いオクターブ**を指定します。

```mml
D @in2 o10 c        ; トーン3を伴うホワイトノイズを超高速回転させる
```
※SN76489のレジスタ限界付近（`o10` や `o11`）を指定することで、レジスタ値 `R=1` などの超音波クロックが供給され、絹のように細かいノイズになります（※メロディとしての音程破綻の影響は受けません）。

#### 💡 ノウハウ②: 効果音（スネアドラム、爆発音）の作成
同期ノイズは**C/Gのピッチ変化にリアルタイムで追従する**ため、トーン3のピッチをエンベロープ（`@EP`）で急降下させると、ノイズの密度が急激に荒くなり「ドシゥゥゥン！」という迫力のある爆発音や打楽器音を作れます。

**スネアドラムの作成例:**
```mml
@v0 = {15, 10, 5, 2, 0}
@EP0 = {0, -100, -200, -300, -400, -500} ; ピッチを急降下させる

D @in2 @v0 EP0 o8c4  ; C/Gのピッチを急降下させながら連動ホワイトノイズを鳴らす
```
このように、ドラムや効果音を作りたい場合は**「異常な高音（`o8`など）から急降下エンベロープをかける」**のがSN76489における最高のテクニックです。周期ノイズ(`@in1`)に適用するとレーザー音やUFOの飛行音になります。
